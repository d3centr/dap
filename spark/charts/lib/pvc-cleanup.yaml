# originally used with statefulSets

# set kubectlImage, e.g. bitnami/kubectl:1.23.0-debian-10-r4
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-reset-pv
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  template:
    metadata:
      name: {{ .Release.Name }}-reset-pv
    spec:
      restartPolicy: Never
      serviceAccountName: {{ .Release.Name }}-reset-pv
      containers:
      - name: {{ .Release.Name }}-reset-pv
        image: {{ .Values.kubectlImage }}
        args: ["delete","pvc","-n","{{ .Values.namespace }}","-l","app.kubernetes.io/name={{ .Values.appName }}"]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Release.Name }}-reset-pv
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: {{ .Release.Name }}-reset-pv
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
rules:
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["list", "delete"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: {{ .Release.Name }}-reset-pv
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
subjects:
- kind: ServiceAccount
  name: {{ .Release.Name }}-reset-pv
  apiGroup: ""
roleRef:
  kind: Role
  name: {{ .Release.Name }}-reset-pv
  apiGroup: ""

